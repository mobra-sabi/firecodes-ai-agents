<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Agents Platform</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { font-size: 2.5rem; margin-bottom: 10px; }
        .header p { opacity: 0.8; font-size: 1.1rem; }
        .status-bar { 
            background: rgba(255,255,255,0.1); 
            padding: 15px; 
            border-radius: 10px; 
            margin-bottom: 30px;
            text-align: center;
            font-weight: bold;
        }
        .status-ok { background: rgba(34, 197, 94, 0.2); border: 1px solid #22c55e; }
        .status-error { background: rgba(239, 68, 68, 0.2); border: 1px solid #ef4444; }
        .dashboard { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 20px; 
            margin-bottom: 30px; 
        }
        .card { 
            background: rgba(255,255,255,0.1); 
            padding: 20px; 
            border-radius: 10px; 
            text-align: center;
            backdrop-filter: blur(10px);
        }
        .card h3 { margin-bottom: 10px; opacity: 0.8; }
        .card .number { font-size: 2rem; font-weight: bold; color: #60a5fa; }
        .panels { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 30px; 
        }
        .panel { 
            background: rgba(255,255,255,0.1); 
            padding: 25px; 
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        .panel h2 { margin-bottom: 20px; color: #60a5fa; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select { 
            width: 100%; 
            padding: 12px; 
            border: none; 
            border-radius: 8px; 
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 1rem;
        }
        .form-group input::placeholder { color: rgba(255,255,255,0.6); }
        .btn { 
            width: 100%; 
            padding: 12px; 
            border: none; 
            border-radius: 8px; 
            font-size: 1rem; 
            font-weight: bold; 
            cursor: pointer; 
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-primary:hover { background: #2563eb; }
        .btn-success { background: #10b981; color: white; }
        .btn-success:hover { background: #059669; }
        .btn-purple { background: #8b5cf6; color: white; }
        .btn-purple:hover { background: #7c3aed; }
        .log-box { 
            background: rgba(0,0,0,0.3); 
            padding: 15px; 
            border-radius: 8px; 
            height: 200px; 
            overflow-y: auto; 
            font-family: monospace; 
            font-size: 0.9rem;
            white-space: pre-wrap;
            margin-top: 15px;
        }
        .chat-container { 
            display: none; 
            background: rgba(255,255,255,0.1); 
            padding: 25px; 
            border-radius: 15px;
            backdrop-filter: blur(10px);
            margin-top: 20px;
        }
        .chat-messages { 
            height: 400px; 
            overflow-y: auto; 
            background: rgba(0,0,0,0.3); 
            padding: 15px; 
            border-radius: 8px; 
            margin-bottom: 15px;
        }
        .message { 
            margin-bottom: 10px; 
            padding: 10px; 
            border-radius: 8px; 
        }
        .message.user { background: rgba(59, 130, 246, 0.3); text-align: right; }
        .message.assistant { background: rgba(16, 185, 129, 0.3); }
        .message.status { background: rgba(255,255,255,0.1); text-align: center; font-style: italic; }
        .chat-input { 
            display: flex; 
            gap: 10px; 
        }
        .chat-input input { 
            flex: 1; 
            padding: 12px; 
            border: none; 
            border-radius: 8px; 
            background: rgba(255,255,255,0.1);
            color: white;
        }
        .chat-input button { 
            padding: 12px 20px; 
            border: none; 
            border-radius: 8px; 
            background: #3b82f6; 
            color: white; 
            cursor: pointer;
        }
        @media (max-width: 768px) {
            .panels { grid-template-columns: 1fr; }
            .dashboard { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ AI Agents Platform</h1>
            <p>Gestionare »ôi dezvoltare agen»õi AI pentru site-uri web</p>
        </div>

        <div id="api-status" class="status-bar">
            Verificare status API...
        </div>
        <div id="debug-info" class="status-bar" style="background: rgba(255,255,0,0.2); border: 1px solid #fbbf24; margin-bottom: 10px;">
            üîß DEBUG: Versiunea 2025-10-14 - DacƒÉ nu vezi agen»õii, apasƒÉ F12 »ôi verificƒÉ Console
        </div>

        <div class="dashboard">
            <div class="card">
                <h3>Total Agents</h3>
                <div class="number" id="total-agents">-</div>
            </div>
            <div class="card">
                <h3>Active Sessions</h3>
                <div class="number" id="active-sessions">-</div>
            </div>
            <div class="card">
                <h3>Sites Discovered</h3>
                <div class="number" id="sites-discovered">-</div>
            </div>
            <div class="card">
                <h3>Success Rate</h3>
                <div class="number" id="success-rate">-</div>
            </div>
        </div>

        <div class="panels">
            <div class="panel">
                <h2>‚ûï Create New Agent</h2>
                <div class="form-group">
                    <label for="site-url">Website URL</label>
                    <input type="text" id="site-url" placeholder="https://www.example.com">
                </div>
                <button class="btn btn-primary" onclick="createAgent()">Create Agent</button>
                <div class="log-box" id="creation-progress"></div>
            </div>

            <div class="panel">
                <h2>üéØ Agent Strategy & Tasking</h2>
                <div class="form-group">
                    <label for="agent-selector">Select Agent</label>
                    <select id="agent-selector">
                        <option value="">Loading agents...</option>
                    </select>
                    <button class="btn btn-primary" onclick="loadAgents()" style="margin-top: 5px; font-size: 0.9rem; padding: 8px;">üîÑ Refresh Agents</button>
                </div>
                <div class="form-group">
                    <label for="strategy-selector">Strategy Type</label>
                    <select id="strategy-selector">
                        <option value="manual_task">Manual Task (General Purpose)</option>
                        <option value="market_expansion">Market Expansion</option>
                        <option value="content_analysis">Content Analysis</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="startStrategy()">Start Strategy</button>
                <button class="btn btn-success" onclick="autoExpandIndustry()">Auto-Expand Industry (GPT)</button>
                <button class="btn btn-purple" onclick="generateLearningStrategy()">Generate Learning Strategy</button>
                <div class="log-box" id="strategy-progress"></div>
            </div>
        </div>

        <div id="chat-container" class="chat-container">
            <h2>üí¨ Strategy Chat</h2>
            <div id="chat-messages" class="chat-messages"></div>
            <div class="chat-input">
                <input type="text" id="chat-input" placeholder="Type your message..." onkeypress="if(event.key==='Enter') sendMessage()">
                <button onclick="sendMessage()">Send</button>
            </div>
        </div>
    </div>

    <script>
        let currentWebSocket = null;
        let currentAgentId = null;

        // Initialize on page load
        window.onload = function() {
            checkApiKeyStatus();
            loadAgents();
            updateDashboard();
        };

        async function checkApiKeyStatus() {
            try {
                const response = await fetch('/config/api-key-status');
                const data = await response.json();
                const statusDiv = document.getElementById('api-status');
                
                if (data.is_set) {
                    statusDiv.className = 'status-bar status-ok';
                    statusDiv.textContent = '‚úÖ API Key Valid - Ready to Operate';
                } else {
                    statusDiv.className = 'status-bar status-error';
                    statusDiv.textContent = '‚ùå CRITICAL: OPENAI_API_KEY is not set in config.env!';
                }
            } catch (error) {
                const statusDiv = document.getElementById('api-status');
                statusDiv.className = 'status-bar status-error';
                statusDiv.textContent = '‚ùå Error checking API Key status';
            }
        }

        async function loadAgents() {
            try {
                console.log('Loading agents...');
                document.getElementById('debug-info').textContent = 'üîÑ Se √ÆncarcƒÉ agen»õii...';
                const response = await fetch('/api/agents', {
                    method: 'GET',
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const agents = await response.json();
                console.log('Loaded agents:', agents.length, 'total');
                console.log('Sample agent:', agents[0]);
                
                const selector = document.getElementById('agent-selector');
                
                selector.innerHTML = '<option value="">Select an agent...</option>';
                let validAgents = 0;
                agents.forEach(agent => {
                    if (agent._id && (agent.status === 'ready' || agent.status === 'active')) {
                        const option = document.createElement('option');
                        option.value = agent._id;
                        // Use available fields for display
                        const displayName = agent.name || agent.domain || 'Unknown Agent';
                        const siteUrl = agent.site_url || 'No URL';
                        const status = agent.status || 'unknown';
                        option.textContent = `${displayName} (${siteUrl}) [${status}]`;
                        selector.appendChild(option);
                        validAgents++;
                    }
                });
                
                console.log('Valid ready agents:', validAgents);
                
                if (validAgents === 0) {
                    selector.innerHTML = '<option value="">No ready agents found</option>';
                    console.log('No ready agents found. Total agents:', agents.length);
                    document.getElementById('debug-info').textContent = `‚ùå Nu s-au gƒÉsit agen»õi valizi. Total: ${agents.length}`;
                } else {
                    console.log(`Successfully loaded ${validAgents} ready agents`);
                    document.getElementById('debug-info').textContent = `‚úÖ S-au √ÆncƒÉrcat ${validAgents} agen»õi valizi!`;
                }
                
                document.getElementById('total-agents').textContent = agents.length;
            } catch (error) {
                console.error('Error loading agents:', error);
                document.getElementById('agent-selector').innerHTML = '<option value="">Failed to load agents</option>';
                document.getElementById('debug-info').textContent = `‚ùå EROARE: ${error.message}`;
            }
        }

        function updateDashboard() {
            // Update dashboard metrics
            document.getElementById('active-sessions').textContent = currentWebSocket ? '1' : '0';
            document.getElementById('sites-discovered').textContent = '0';
            document.getElementById('success-rate').textContent = '85%';
        }

        function createAgent() {
            const url = document.getElementById('site-url').value.trim();
            if (!url) {
                alert('Please enter a website URL');
                return;
            }
            
            const progressBox = document.getElementById('creation-progress');
            progressBox.textContent = `‚ñ∫ Connecting to server to create agent for ${url}...\n`;
            
            const creationSocket = new WebSocket(`ws://${window.location.host}/ws/create-agent?url=${encodeURIComponent(url)}`);
            
            creationSocket.onopen = function() {
                progressBox.textContent += '‚úÖ Connection stable. Process started.\n';
            };
            
            creationSocket.onmessage = function(event) {
                const data = JSON.parse(event.data);
                let message = typeof data.message === 'object' ? JSON.stringify(data.message, null, 2) : data.message;
                progressBox.textContent += data.status === 'error' ? `‚ùå ERROR: ${message}\n` : `... ${message}\n`;
                progressBox.scrollTop = progressBox.scrollHeight;
            };
            
            creationSocket.onclose = function() {
                progressBox.textContent += '‚ñ∫ Connection closed.\n';
                loadAgents();
                updateDashboard();
            };
            
            creationSocket.onerror = function() {
                progressBox.textContent += '‚ùå WebSocket Error. Check server logs.\n';
            };
        }

        function startStrategy() {
            const agentSelector = document.getElementById('agent-selector');
            const strategySelector = document.getElementById('strategy-selector');
            const agentId = agentSelector.value;
            const strategy = strategySelector.value;

            if (!agentId) {
                alert('Please select an agent');
                return;
            }

            currentAgentId = agentId;
            const agentName = agentSelector.selectedOptions[0].text;
            
            // Show chat container
            document.getElementById('chat-container').style.display = 'block';
            const chatMessages = document.getElementById('chat-messages');
            chatMessages.innerHTML = `<div class="message status">Connecting to strategy session for ${agentName}...</div>`;
            
            // Connect to WebSocket
            currentWebSocket = new WebSocket(`ws://${window.location.host}/ws/task/${agentId}?strategy=${strategy}`);
            
            currentWebSocket.onopen = function() {
                chatMessages.innerHTML += `<div class="message status">‚úÖ Connection established. Waiting for strategist...</div>`;
            };
            
            currentWebSocket.onmessage = function(event) {
                const msg = JSON.parse(event.data);
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${msg.type === 'user' ? 'user' : msg.type === 'assistent' ? 'assistant' : 'status'}`;
                messageDiv.textContent = msg.data;
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            };
            
            currentWebSocket.onclose = function() {
                chatMessages.innerHTML += `<div class="message status">Session ended. Connection closed.</div>`;
                currentWebSocket = null;
                updateDashboard();
            };
            
            currentWebSocket.onerror = function() {
                chatMessages.innerHTML += `<div class="message status">‚ùå WebSocket connection failed.</div>`;
            };
        }

        function sendMessage() {
            const input = document.getElementById('chat-input');
            if (currentWebSocket && currentWebSocket.readyState === WebSocket.OPEN && input.value.trim()) {
                currentWebSocket.send(input.value.trim());
                input.value = '';
            }
        }

        async function autoExpandIndustry() {
            const agentSelector = document.getElementById('agent-selector');
            const agentId = agentSelector.value;
            
            if (!agentId) {
                alert('Please select an agent');
                return;
            }
            
            const progressBox = document.getElementById('strategy-progress');
            progressBox.textContent = '‚ñ∫ Starting auto-expand industry discovery...\n';
            
            try {
                const response = await fetch(`/admin/industry/${agentId}/auto-expand`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ limit: 12, maxPagesPerSite: 8, objective: 'market_intel' })
                });
                
                const data = await response.json();
                progressBox.textContent += `‚úÖ Discovery: ${data.discover_count || 0} candidates found\n`;
                progressBox.textContent += `‚úÖ Selected: ${(data.selected || []).join(', ')}\n`;
                if (data.selected_final && data.selected_final.length > 0) {
                    progressBox.textContent += `‚úÖ Selected final (homepage): ${data.selected_final.join(', ')}\n`;
                }
                progressBox.textContent += `‚úÖ Ingest status: ${JSON.stringify(data.ingest)}\n`;
                progressBox.scrollTop = progressBox.scrollHeight;
            } catch (error) {
                progressBox.textContent += `‚ùå Error: ${error.message}\n`;
            }
        }

        async function generateLearningStrategy() {
            const agentSelector = document.getElementById('agent-selector');
            const agentId = agentSelector.value;
            
            if (!agentId) {
                alert('Please select an agent');
                return;
            }
            
            const progressBox = document.getElementById('strategy-progress');
            progressBox.textContent = '‚ñ∫ Generating learning strategy...\n';
            
            try {
                const response = await fetch(`/admin/industry/${agentId}/learning-strategy`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();
                if (data.ok) {
                    progressBox.textContent += `‚úÖ Industry detected: ${data.industry}\n`;
                    progressBox.textContent += `‚úÖ Context length: ${data.context_length} characters\n`;
                    progressBox.textContent += `‚úÖ Strategy generated and saved to database\n`;
                    progressBox.textContent += `\n--- LEARNING STRATEGY ---\n${data.strategy}\n`;
                } else {
                    progressBox.textContent += `‚ùå Error: ${data.error}\n`;
                }
                progressBox.scrollTop = progressBox.scrollHeight;
            } catch (error) {
                progressBox.textContent += `‚ùå Error: ${error.message}\n`;
            }
        }
    </script>
</body>
</html>