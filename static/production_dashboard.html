<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Production Dashboard - AI Agents Platform</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .header {
            background: white;
            padding: 30px;
            border-radius: 16px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .header h1 {
            color: #667eea;
            font-size: 36px;
            margin-bottom: 10px;
        }
        .header p {
            color: #666;
            font-size: 16px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            margin-bottom: 15px;
            color: white;
        }
        .stat-icon.blue { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .stat-icon.green { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
        .stat-icon.orange { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .stat-icon.purple { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .stat-value {
            font-size: 42px;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        .stat-label {
            color: #666;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .stat-trend {
            margin-top: 10px;
            font-size: 12px;
            color: #28a745;
        }
        .section {
            background: white;
            padding: 30px;
            border-radius: 16px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .section-title {
            color: #667eea;
            font-size: 24px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 3px solid #667eea;
        }
        .agents-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }
        .agent-item {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid #667eea;
        }
        .agent-domain {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
        }
        .agent-info {
            font-size: 13px;
            color: #666;
            margin: 5px 0;
        }
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: bold;
            margin-right: 5px;
        }
        .badge-master { background: #667eea; color: white; }
        .badge-slave { background: #6c757d; color: white; }
        .badge-ready { background: #28a745; color: white; }
        .system-health {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .health-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .health-status {
            font-size: 36px;
            margin-bottom: 10px;
        }
        .health-label {
            color: #666;
            font-size: 14px;
        }
        .loading {
            text-align: center;
            padding: 60px;
            color: #666;
        }
        .refresh-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            float: right;
            transition: all 0.3s;
        }
        .refresh-btn:hover {
            background: #764ba2;
            transform: scale(1.05);
        }
        .actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .action-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 25px;
            border-radius: 16px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        .action-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(102, 126, 234, 0.4);
        }
        .action-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        .action-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .action-desc {
            font-size: 14px;
            opacity: 0.9;
        }
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            margin: 5px;
        }
        .btn:hover {
            background: #764ba2;
            transform: scale(1.05);
        }
        .btn-success {
            background: #28a745;
        }
        .btn-success:hover {
            background: #218838;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal.active {
            display: flex;
        }
        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 16px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .modal-title {
            color: #667eea;
            font-size: 28px;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            color: #333;
            font-weight: bold;
            margin-bottom: 8px;
        }
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1><i class="fas fa-chart-line"></i> Production Dashboard</h1>
        <p>Monitorizare sistem AI Agents √Æn timp real</p>
        <button class="refresh-btn" onclick="loadDashboard()">
            <i class="fas fa-sync"></i> Refresh
        </button>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon blue">
                <i class="fas fa-robot"></i>
            </div>
            <div class="stat-value" id="totalAgents">-</div>
            <div class="stat-label">Total Agen»õi</div>
            <div class="stat-trend">
                <i class="fas fa-arrow-up"></i> <span id="agentTrend">+0 recent</span>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon green">
                <i class="fas fa-users"></i>
            </div>
            <div class="stat-value" id="masterAgents">-</div>
            <div class="stat-label">Master Agents</div>
            <div class="stat-trend">
                <i class="fas fa-check-circle"></i> <span id="masterTrend">Active</span>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon orange">
                <i class="fas fa-network-wired"></i>
            </div>
            <div class="stat-value" id="slaveAgents">-</div>
            <div class="stat-label">Slave Agents</div>
            <div class="stat-trend">
                <i class="fas fa-link"></i> <span id="slaveTrend">Connected</span>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon purple">
                <i class="fas fa-chart-bar"></i>
            </div>
            <div class="stat-value" id="readyAgents">-</div>
            <div class="stat-label">Ready Status</div>
            <div class="stat-trend">
                <i class="fas fa-heartbeat"></i> <span id="readyTrend">100%</span>
            </div>
        </div>
    </div>

    <div class="section">
        <div class="section-title">
            <i class="fas fa-server"></i> System Health
        </div>
        <div class="system-health">
            <div class="health-item">
                <div class="health-status">‚úÖ</div>
                <div class="health-label" id="apiStatus">API Online</div>
            </div>
            <div class="health-item">
                <div class="health-status">‚úÖ</div>
                <div class="health-label" id="mongoStatus">MongoDB Connected</div>
            </div>
            <div class="health-item">
                <div class="health-status">‚úÖ</div>
                <div class="health-label" id="qdrantStatus">Qdrant Active</div>
            </div>
            <div class="health-item">
                <div class="health-status">‚úÖ</div>
                <div class="health-label" id="llmStatus">LLM Ready</div>
            </div>
        </div>
    </div>

    <div class="section">
        <div class="section-title">
            <i class="fas fa-tools"></i> Production Actions
        </div>
        <div class="actions-grid">
            <div class="action-card" onclick="openCreateAgentModal()">
                <div class="action-icon">
                    <i class="fas fa-plus-circle"></i>
                </div>
                <div class="action-title">Create New Agent</div>
                <div class="action-desc">CreeazƒÉ agent master nou pentru un website</div>
            </div>

            <div class="action-card" onclick="window.open('/static/master_control_panel.html', '_blank')">
                <div class="action-icon">
                    <i class="fas fa-cogs"></i>
                </div>
                <div class="action-title">Control Panel</div>
                <div class="action-desc">Management complet agen»õi</div>
            </div>

            <div class="action-card" onclick="runBulkDiscovery()">
                <div class="action-icon">
                    <i class="fas fa-search"></i>
                </div>
                <div class="action-title">Bulk Discovery</div>
                <div class="action-desc">DescoperƒÉ competitori pentru to»õi agen»õii</div>
            </div>

            <div class="action-card" onclick="viewSystemLogs()">
                <div class="action-icon">
                    <i class="fas fa-file-alt"></i>
                </div>
                <div class="action-title">System Logs</div>
                <div class="action-desc">Monitorizare logs »ôi activitate</div>
            </div>
        </div>
    </div>

    <div class="section">
        <div class="section-title">
            <i class="fas fa-list"></i> All Agents
        </div>
        <div id="agentsList" class="loading">
            <i class="fas fa-spinner fa-spin"></i> Loading agents...
        </div>
    </div>

    <!-- Create Agent Modal -->
    <div class="modal" id="createAgentModal">
        <div class="modal-content">
            <h2 class="modal-title">
                <i class="fas fa-robot"></i> Create New Master Agent
            </h2>
            <form id="createAgentForm" onsubmit="createAgent(event)">
                <div class="form-group">
                    <label for="agentUrl">
                        <i class="fas fa-link"></i> Website URL
                    </label>
                    <input 
                        type="text" 
                        id="agentUrl" 
                        placeholder="example.com sau https://example.com" 
                        required
                    >
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="runAnalysis" checked>
                        RuleazƒÉ analizƒÉ DeepSeek
                    </label>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="discoverCompetitors" checked>
                        DescoperƒÉ competitori automat
                    </label>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="createSlaves" checked>
                        CreeazƒÉ slave agents (TOP 15)
                    </label>
                </div>
                <div style="text-align: center; margin-top: 30px;">
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-rocket"></i> Create Agent
                    </button>
                    <button type="button" class="btn" onclick="closeModal()">
                        Cancel
                    </button>
                </div>
                <div id="createStatus" style="margin-top: 20px; text-align: center;"></div>
                
                <!-- Real-time Progress Details -->
                <div id="progressDetails" style="display: none; margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px; max-height: 300px; overflow-y: auto;">
                    <h4 style="color: #667eea; margin-bottom: 10px;">üìä Real-Time Progress</h4>
                    <div id="progressLog" style="font-family: monospace; font-size: 12px; line-height: 1.8;"></div>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;

        async function loadDashboard() {
            console.log('üìä Loading production dashboard...');
            
            try {
                // Load agents
                const response = await fetch(`${API_BASE}/api/agents`);
                const agents = await response.json();
                
                console.log('‚úÖ Loaded', agents.length, 'agents');
                
                // Calculate stats
                const totalAgents = agents.length;
                const masterAgents = agents.filter(a => a.agent_type !== 'slave').length;
                const slaveAgents = agents.filter(a => a.agent_type === 'slave').length;
                const readyAgents = agents.filter(a => a.status === 'ready').length;
                
                // Update stats
                document.getElementById('totalAgents').textContent = totalAgents;
                document.getElementById('masterAgents').textContent = masterAgents;
                document.getElementById('slaveAgents').textContent = slaveAgents;
                document.getElementById('readyAgents').textContent = readyAgents;
                
                document.getElementById('agentTrend').textContent = `${totalAgents} total`;
                document.getElementById('masterTrend').textContent = `${masterAgents} active`;
                document.getElementById('slaveTrend').textContent = `${slaveAgents} connected`;
                document.getElementById('readyTrend').textContent = `${Math.round(readyAgents/totalAgents*100)}% ready`;
                
                // Display agents
                const agentsList = document.getElementById('agentsList');
                if (agents.length === 0) {
                    agentsList.innerHTML = '<p style="text-align: center; color: #666;">Niciun agent disponibil</p>';
                    return;
                }
                
                const html = agents.map(agent => {
                    const domain = agent.domain || 'Unknown';
                    const agentType = agent.agent_type === 'slave' ? 'Slave' : 'Master';
                    const status = agent.status || 'ready';
                    
                    return `
                        <div class="agent-item">
                            <div class="agent-domain">${domain}</div>
                            <div>
                                <span class="badge ${agent.agent_type === 'slave' ? 'badge-slave' : 'badge-master'}">
                                    ${agentType}
                                </span>
                                <span class="badge badge-ready">${status}</span>
                            </div>
                            <div class="agent-info">üìå ID: ${agent._id}</div>
                            <div class="agent-info">üîó ${agent.site_url || 'N/A'}</div>
                        </div>
                    `;
                }).join('');
                
                agentsList.innerHTML = `<div class="agents-list">${html}</div>`;
                
                // Update system health
                document.getElementById('apiStatus').textContent = 'API Online';
                document.getElementById('mongoStatus').textContent = `MongoDB (${totalAgents} docs)`;
                document.getElementById('qdrantStatus').textContent = 'Qdrant Active';
                document.getElementById('llmStatus').textContent = 'LLM Ready';
                
            } catch (error) {
                console.error('‚ùå Error:', error);
                document.getElementById('agentsList').innerHTML = 
                    `<p style="color: red; text-align: center;">Eroare: ${error.message}</p>`;
            }
        }

        // Production Actions
        function openCreateAgentModal() {
            document.getElementById('createAgentModal').classList.add('active');
            document.getElementById('createAgentForm').reset();
            document.getElementById('createStatus').innerHTML = '';
        }

        function closeModal() {
            document.getElementById('createAgentModal').classList.remove('active');
        }

        // Helper function to log progress
        function logProgress(message, type = 'info') {
            const progressLog = document.getElementById('progressLog');
            const progressDetails = document.getElementById('progressDetails');
            progressDetails.style.display = 'block';
            
            const timestamp = new Date().toLocaleTimeString();
            const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : 'üìã';
            const color = type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : type === 'warning' ? '#ffc107' : '#667eea';
            
            progressLog.innerHTML += `<div style="color: ${color}; margin: 5px 0;">[${timestamp}] ${icon} ${message}</div>`;
            progressLog.scrollTop = progressLog.scrollHeight;
        }

        async function createAgent(event) {
            event.preventDefault();
            
            let url = document.getElementById('agentUrl').value.trim();
            
            // Validare »ôi normalizare URL
            if (!url) {
                alert('‚ùå Te rog introdu un URL!');
                return;
            }
            
            // Normalizare: adaugƒÉ https:// dacƒÉ lipse»ôte
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                url = 'https://' + url;
            }
            
            // Validare simplƒÉ: verificƒÉ dacƒÉ are cel pu»õin un punct
            if (!url.includes('.')) {
                alert('‚ùå URL invalid! Te rog introdu un domeniu valid (ex: example.com)');
                return;
            }
            
            const runAnalysis = document.getElementById('runAnalysis').checked;
            const discoverCompetitors = document.getElementById('discoverCompetitors').checked;
            const createSlaves = document.getElementById('createSlaves').checked;
            
            const statusDiv = document.getElementById('createStatus');
            const progressLog = document.getElementById('progressLog');
            
            // Reset logs
            progressLog.innerHTML = '';
            document.getElementById('progressDetails').style.display = 'block';
            
            statusDiv.innerHTML = '<p style="color: #667eea;">‚è≥ Workflow started...</p>';
            logProgress('üöÄ Starting agent creation workflow', 'info');
            logProgress(`üìå Target URL: ${url}`, 'info');
            
            try {
                // Step 1: Create agent
                logProgress('Step 1/4: Creating base agent...', 'info');
                const startTime = Date.now();
                
                const response = await fetch(`${API_BASE}/api/agents/create`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ site_url: url })
                });
                
                const data = await response.json();
                const duration = ((Date.now() - startTime) / 1000).toFixed(2);
                
                if (!data.ok) {
                    throw new Error(data.error || 'Failed to create agent');
                }
                
                const agentId = data.agent._id;
                const domain = data.agent.domain;
                
                logProgress(`‚úÖ Agent created: ${domain} (ID: ${agentId})`, 'success');
                logProgress(`‚è±Ô∏è Creation time: ${duration}s`, 'info');
                statusDiv.innerHTML = `<p style="color: #28a745;">‚úÖ Agent: ${domain}</p>`;
                
                // Step 2: Run analysis if checked
                if (runAnalysis) {
                    logProgress('Step 2/4: Running DeepSeek analysis...', 'info');
                    const analysisStart = Date.now();
                    
                    const analysisRes = await fetch(`${API_BASE}/agents/${agentId}/analyze-competition`, {
                        method: 'POST'
                    });
                    const analysisData = await analysisRes.json();
                    const analysisDuration = ((Date.now() - analysisStart) / 1000).toFixed(2);
                    
                    logProgress(`‚úÖ DeepSeek analysis complete (${analysisDuration}s)`, 'success');
                    if (analysisData.analysis) {
                        logProgress(`üìä Analysis saved with ${Object.keys(analysisData.analysis).length} data points`, 'info');
                    }
                } else {
                    logProgress('‚è≠Ô∏è Skipping DeepSeek analysis', 'warning');
                }
                
                // Step 3: Discover competitors if checked
                if (discoverCompetitors) {
                    logProgress('Step 3/4: Discovering competitors via SERP...', 'info');
                    const discoverStart = Date.now();
                    
                    const discoverRes = await fetch(`${API_BASE}/agents/${agentId}/discover-competitors`, {
                        method: 'POST'
                    });
                    const discoverData = await discoverRes.json();
                    const discoverDuration = ((Date.now() - discoverStart) / 1000).toFixed(2);
                    
                    const competitorCount = discoverData.discovery?.total_competitors_found || 0;
                    logProgress(`‚úÖ Discovery complete: ${competitorCount} competitors found (${discoverDuration}s)`, 'success');
                    
                    if (competitorCount > 0) {
                        logProgress(`üìä Top competitors: ${discoverData.discovery?.top_domains?.slice(0, 5).join(', ') || 'N/A'}`, 'info');
                    }
                } else {
                    logProgress('‚è≠Ô∏è Skipping competitor discovery', 'warning');
                }
                
                // Step 4: Create slaves if checked
                if (createSlaves && discoverCompetitors) {
                    logProgress('Step 4/4: Creating slave agents (TOP 15, min_score: 40)...', 'info');
                    const slavesStart = Date.now();
                    
                    const slavesRes = await fetch(`${API_BASE}/agents/${agentId}/create-competitor-agents`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ max_agents: 15, min_score: 40 })
                    });
                    const slavesData = await slavesRes.json();
                    const slavesDuration = ((Date.now() - slavesStart) / 1000).toFixed(2);
                    
                    const createdCount = slavesData.created_count || 0;
                    logProgress(`‚úÖ Slave agents created: ${createdCount} agents (${slavesDuration}s)`, 'success');
                    
                    if (slavesData.created_agents) {
                        slavesData.created_agents.slice(0, 5).forEach(agent => {
                            logProgress(`  ‚Üí ${agent.domain}`, 'info');
                        });
                        if (createdCount > 5) {
                            logProgress(`  ... and ${createdCount - 5} more`, 'info');
                        }
                    }
                } else {
                    logProgress('‚è≠Ô∏è Skipping slave agent creation', 'warning');
                }
                
                const totalDuration = ((Date.now() - startTime) / 1000).toFixed(2);
                logProgress(`üéâ Workflow complete! Total time: ${totalDuration}s`, 'success');
                logProgress(`üìä Dashboard will refresh in 3 seconds...`, 'info');
                
                statusDiv.innerHTML = '<p style="color: #28a745; font-weight: bold;">üéâ All done!</p>';
                
                // Reload dashboard after 3 seconds
                setTimeout(() => {
                    closeModal();
                    loadDashboard();
                }, 3000);
                
            } catch (error) {
                console.error('Error:', error);
                logProgress(`‚ùå ERROR: ${error.message}`, 'error');
                logProgress(error.stack || 'No stack trace available', 'error');
                statusDiv.innerHTML = `<p style="color: #dc3545;">‚ùå Error: ${error.message}</p>`;
            }
        }

        async function runBulkDiscovery() {
            if (!confirm('Run discovery for ALL agents? This may take a while.')) return;
            
            alert('üîç Bulk discovery started! Check System Logs for progress.');
            // TODO: Implement bulk discovery endpoint
        }

        function viewSystemLogs() {
            alert('üìã System Logs\n\nViewing last 100 entries...\n\n(Feature in development)');
            // TODO: Implement logs viewer
        }

        // Load on start
        document.addEventListener('DOMContentLoaded', loadDashboard);

        // Auto-refresh every 30 seconds
        setInterval(loadDashboard, 30000);
    </script>
</body>
</html>
